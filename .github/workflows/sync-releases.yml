name: Sync Missing Releases

on:
  workflow_dispatch:  # Manual trigger
  schedule:
    # Run daily at 2 AM UTC to check for missing releases
    - cron: '0 2 * * *'
  push:
    tags:
      - 'v*'  # Also run when a new tag is pushed (as backup)

jobs:
  sync-releases:
    name: Sync Missing Releases
    runs-on: ubuntu-latest
    permissions:
      contents: read
      contents: write  # Required to create releases

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Required to get all tags and history

      - name: Fetch all tags
        run: git fetch --tags

      - name: Get all tags
        id: tags
        run: |
          # Get all tags starting with 'v' and sort them
          TAGS=$(git tag -l 'v*' | sort -V)
          echo "TAGS<<EOF" >> $GITHUB_OUTPUT
          echo "$TAGS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "Found tags: $TAGS"

      - name: Check existing releases
        id: check-releases
        uses: actions/github-script@v7
        with:
          script: |
            const { data: releases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            const existingReleaseTags = releases.map(r => r.tag_name);
            console.log('Existing releases:', existingReleaseTags);
            
            core.setOutput('tags', JSON.stringify(existingReleaseTags));

      - name: Find missing releases
        id: missing
        run: |
          TAGS="${{ steps.tags.outputs.TAGS }}"
          EXISTING_RELEASES_JSON='${{ steps.check-releases.outputs.tags }}'
          
          # Convert JSON array to space-separated list for easier checking
          EXISTING_RELEASES=$(echo "$EXISTING_RELEASES_JSON" | jq -r '.[]' | tr '\n' ' ')
          
          MISSING_TAGS=""
          
          while IFS= read -r tag; do
            # Check if tag exists in releases
            if ! echo "$EXISTING_RELEASES" | grep -qw "$tag"; then
              if [ -z "$MISSING_TAGS" ]; then
                MISSING_TAGS="$tag"
              else
                MISSING_TAGS="$MISSING_TAGS"$'\n'"$tag"
              fi
              echo "Missing release for tag: $tag"
            fi
          done <<< "$TAGS"
          
          if [ -n "$MISSING_TAGS" ]; then
            echo "MISSING_TAGS<<EOF" >> $GITHUB_OUTPUT
            echo "$MISSING_TAGS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "found_missing=true" >> $GITHUB_OUTPUT
          else
            echo "found_missing=false" >> $GITHUB_OUTPUT
            echo "All tags have releases âœ…"
          fi

      - name: Create missing releases
        if: steps.missing.outputs.found_missing == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const missingTags = `${{ steps.missing.outputs.MISSING_TAGS }}`.trim().split('\n').filter(t => t);
            
            for (const tag of missingTags) {
              console.log(`Creating release for tag: ${tag}`);
              
              // Extract version from tag (remove 'v' prefix)
              const version = tag.replace(/^v/, '');
              
              // Get tag message using git
              const { execSync } = require('child_process');
              let tagMessage = '';
              try {
                tagMessage = execSync(`git tag -l --format='%(contents)' ${tag}`, { encoding: 'utf-8' }).trim();
              } catch (e) {
                tagMessage = `Release ${tag}`;
              }
              
              if (!tagMessage) {
                tagMessage = `Release ${tag}`;
              }
              
              // Get changelog entry
              const fs = require('fs');
              let changelogEntry = '';
              if (fs.existsSync('docs/CHANGELOG.md')) {
                const changelog = fs.readFileSync('docs/CHANGELOG.md', 'utf-8');
                const versionEscaped = version.replace(/\./g, '\\.');
                const regex = new RegExp(`^## \\[${versionEscaped}\\]([\\s\\S]*?)(?=^## \\[?[0-9]|$)`);
                const match = changelog.match(regex);
                if (match) {
                  changelogEntry = match[1].trim();
                }
              }
              
              // Build release body
              let releaseBody = tagMessage;
              if (changelogEntry) {
                releaseBody = `${tagMessage}

## Changelog

${changelogEntry}`;
              }
              
              // Determine if prerelease
              const isPrerelease = tag.includes('-alpha') || tag.includes('-beta') || tag.includes('-rc');
              
              // Create release
              await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: tag,
                name: `Release ${tag}`,
                body: releaseBody,
                draft: false,
                prerelease: isPrerelease,
                generate_release_notes: true
              });
              
              console.log(`âœ… Created release for ${tag}`);
            }

      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.missing.outputs.found_missing }}" == "true" ]; then
            echo "## âœ… Sync Complete" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Created releases for the following tags:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.missing.outputs.MISSING_TAGS }}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "## âœ… All tags have releases" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No missing releases found. Everything is in sync! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          fi

# Maintainer: HÃ©ctor Franco Aceituno (@HecFranco)
# Organization: nowo-tech (https://github.com/nowo-tech)

