name: Sync Missing Releases

on:
  workflow_dispatch:  # Manual trigger
  schedule:
    # Run daily at 2 AM UTC to check for missing releases
    - cron: '0 2 * * *'
  push:
    tags:
      - 'v*'  # Also run when a new tag is pushed (as backup)

jobs:
  sync-releases:
    name: Sync Missing Releases
    runs-on: ubuntu-latest
    permissions:
      contents: read
      contents: write  # Required to create releases

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Required to get all tags and history

      - name: Fetch all tags
        run: git fetch --tags

      - name: Get all tags
        id: tags
        run: |
          # Get all tags starting with 'v' and sort them
          TAGS=$(git tag -l 'v*' | sort -V)
          echo "TAGS<<EOF" >> $GITHUB_OUTPUT
          echo "$TAGS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "Found tags: $TAGS"

      - name: Check existing releases
        id: check-releases
        uses: actions/github-script@v7
        with:
          script: |
            const { data: releases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            const existingReleaseTags = releases.map(r => r.tag_name);
            console.log('Existing releases:', existingReleaseTags);
            
            core.setOutput('tags', JSON.stringify(existingReleaseTags));

      - name: Find missing releases
        id: missing
        uses: actions/github-script@v7
        with:
          script: |
            const tags = `${{ steps.tags.outputs.TAGS }}`.trim().split('\n').filter(t => t);
            const existingReleases = JSON.parse(`${{ steps.check-releases.outputs.tags }}`);
            
            const missingTags = tags.filter(tag => !existingReleases.includes(tag));
            
            if (missingTags.length > 0) {
              console.log('Missing releases for tags:', missingTags);
              core.setOutput('missing_tags', missingTags.join('\n'));
              core.setOutput('found_missing', 'true');
            } else {
              console.log('All tags have releases âœ…');
              core.setOutput('found_missing', 'false');
            }

      - name: Create missing releases
        if: steps.missing.outputs.found_missing == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const missingTags = `${{ steps.missing.outputs.missing_tags }}`.trim().split('\n').filter(t => t);
            
            for (const tag of missingTags) {
              console.log(`Creating release for tag: ${tag}`);
              
              // Extract version from tag (remove 'v' prefix)
              const version = tag.replace(/^v/, '');
              
              // Get tag message using git
              const { execSync } = require('child_process');
              let tagMessage = '';
              try {
                tagMessage = execSync(`git tag -l --format='%(contents)' ${tag}`, { encoding: 'utf-8' }).trim();
              } catch (e) {
                tagMessage = `Release ${tag}`;
              }
              
              if (!tagMessage) {
                tagMessage = `Release ${tag}`;
              }
              
              // Get changelog entry
              const fs = require('fs');
              let changelogEntry = '';
              if (fs.existsSync('docs/CHANGELOG.md')) {
                const changelog = fs.readFileSync('docs/CHANGELOG.md', 'utf-8');
                const versionEscaped = version.replace(/\./g, '\\.');
                const regex = new RegExp(`^## \\[${versionEscaped}\\]([\\s\\S]*?)(?=^## \\[?[0-9]|$)`);
                const match = changelog.match(regex);
                if (match) {
                  changelogEntry = match[1].trim();
                }
              }
              
              // Build release body
              let releaseBody = tagMessage;
              if (changelogEntry) {
                releaseBody = `${tagMessage}

## Changelog

${changelogEntry}`;
              }
              
              // Determine if prerelease
              const isPrerelease = tag.includes('-alpha') || tag.includes('-beta') || tag.includes('-rc');
              
              // Create release
              await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: tag,
                name: `Release ${tag}`,
                body: releaseBody,
                draft: false,
                prerelease: isPrerelease,
                generate_release_notes: true
              });
              
              console.log(`âœ… Created release for ${tag}`);
            }

      - name: Summary
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const foundMissing = '${{ steps.missing.outputs.found_missing }}' === 'true';
            const missingTags = foundMissing ? `${{ steps.missing.outputs.missing_tags }}`.trim().split('\n') : [];
            
            let summary = '';
            if (foundMissing) {
              summary = `## âœ… Sync Complete\n\nCreated releases for the following tags:\n\`\`\`\n${missingTags.join('\n')}\n\`\`\``;
            } else {
              summary = '## âœ… All tags have releases\n\nNo missing releases found. Everything is in sync! ðŸŽ‰';
            }
            
            core.summary.addRaw(summary);
            await core.summary.write();

# Maintainer: HÃ©ctor Franco Aceituno (@HecFranco)
# Organization: nowo-tech (https://github.com/nowo-tech)

